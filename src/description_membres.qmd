---
title: "Professions des membres du CCNE"
author: "Léopold MAURICE"
date: "2024-07-16"
project: CCNE
supervision: Pr. Emmanuel Didier, CMH/ENS/EHESS
format:
  html:
    toc: true
    number-sections: true
    colorlinks: true
    geometry:
      - top=10mm
      - left=20mm
      - right=20mm
      - bottom=10mm  
      - heightrounded
    highlight-style: github
    fontfamily: libertinus
    documentclass: report
    fig-width: 12
    fig-height: 9
  pdf:
    documentclass: article
    geometry: [left=1in, right=1in, top=1in, bottom=1in]
    fontsize: 11pt
    keep-tex: true
    toc: true
    toc-depth: 2
    number-sections: true
execute:
  eval: true
  message: false
  warning: false
  echo: false
  output: true
  error: true
editor: source
---

# [Retour aux choix](https://leopoldmaurice.shinyapps.io/CCNE/)

```{r}
require(pacman,quietly = T)

pacman::p_load(arrow,
               tidyverse,
               reshape2,
               stringr,

               stats,
               rstatix,
               
               ggplot2,
               gridExtra,
               ggprism,
               ggpubr,
               ggcorrplot,
               ComplexHeatmap,
               circlize,
               patchwork,
               rmarkdown,
               readxl)

source("helpers/database_creation.R")
source("helpers/figures.R")

save_figures = F
cutpoints = c(0, 1e-04, 0.001, 0.01, 0.05, 0.1, 1)
symbols = c("****", "***", "**", "*", "•","ns")
significance = c("p < 0.0001", "p < 0.001", "p < 0.01", "p < 0.05", "p < 0.1", "p>0.1")
signif_caption_text <- paste("Significance levels:\n", paste(symbols, ":", significance, collapse = ", "))

```

```{r}
metadata_auteur <- read_excel("../data/raw/collected_metadata/metadata_auteur.xlsx", 
    col_types = c("numeric", "text", "text", 
        "text", "text", "text", "text", 
        "text", "text", "numeric", "text", 
        "text", "text", "skip"))

metadata_auteur <- metadata_auteur|>
  mutate(président = président == "TRUE")

calcul_mandat_durée <- Vectorize(function(début,fin,début2,fin2){
  if(is.na(début2))
    return(fin - début + 1)
  else 
    return(fin - début + 1 + fin2 - début2 + 1)
})

NOW_year = 2024
# Replace "NOW" with the current year in the specified columns using dplyr
metadata_auteur <- metadata_auteur %>%
  mutate(across(c(début, fin, début2, fin2), ~ ifelse(. == "NOW", NOW_year, .))) %>%
  mutate(across(c(début, fin, début2, fin2), as.numeric))%>%
  mutate(président_première_nomination = president_CCNE_by_year(début),
         age_première_nomination = début - naissance + 1,
         durée_mandat = calcul_mandat_durée(début,fin,début2,fin2))

# recodage des professions avec une catégorie unique par membre du ccne
recodage_profession <- Vectorize(function(profession, spécialité){
  profession = strsplit(profession, ";")[[1]]
  spécialité = strsplit(spécialité, ";")[[1]]
  if('politicien' %in% profession | 'militant' %in% profession){
    return('politicien ou militant') # un politicien qui fut médecin est classé comme politicien
  }
  else if('journaliste' %in% profession | 'presse' %in% profession){
    return('journaliste/presse')
  }
  else if('théologien' %in% profession){
    return('théologien')
  }
  else if('médecin' %in% profession & !('généraliste' %in% spécialité)){
    return('médecin PUPH')
  }
  else if('biologiste' %in% profession | 'physiologie' %in% spécialité | 'pharmacologie' %in% spécialité){
    return('chercheur bio')
  }
  else if('pharmacien' %in% profession | 'infirmier' %in% profession | 'infirmière' %in% profession | 'psychologue' %in% profession | 'généraliste' %in% spécialité | 'cadre supérieur santé' %in% profession)
    return('autres professions santé')
  else if('avocat' %in% profession | 'magistrat' %in% profession | 'juge' %in% profession | 'juriste' %in% profession)
    return('profession du droit')
  else if('haut fonctionnaire' %in% profession | 'ENArque' %in% profession | 'cadre' %in% profession | 'ingénieur' %in% profession)
    return('cadre public/privé')
  else if('chercheur' %in% profession | 'professeur agrégé' %in% profession | "professeur d'université" %in% profession){
    if('droit' %in% spécialité)
      return("chercheur droit")
    if('sociologie' %in% spécialité | 'anthropologie' %in% spécialité | 'histoire' %in% spécialité | 'économie' %in% spécialité | 'psychologie' %in% spécialité | 'démographie' %in% spécialité | 'philosophie' %in% spécialité | 'géographie' %in% spécialité | 'judaïsme' %in% spécialité | 'sciences politiques'  %in% spécialité | 'littérature' %in% spécialité | 'musée' %in% spécialité | 'protestantisme' %in% spécialité
)
      return('chercheur SHS')
    if('mathématiques' %in% spécialité | 'chimie' %in% spécialité | 'physique' %in% spécialité | 'informatique' %in% spécialité)
      return('chercheur sciences exactes')
  }
  else{
    return("inconnue")
  }
})

metadata_auteur <- metadata_auteur%>%
  mutate(profession_recodée = recodage_profession(profession,spécialité))%>%
  mutate(profession_recodée = as.character(profession_recodée))%>%
  mutate(profession_recodée = factor(profession_recodée, 
                                     levels = c(
                                       "médecin PUPH","chercheur bio",
                                       "autres professions santé",
                                       "politicien ou militant",
                                       "cadre public/privé","journaliste/presse",
                                       "théologien","profession du droit",
                                       "chercheur droit","chercheur SHS",
                                       "chercheur sciences exactes","inconnue")))
metadata_avis <- open_metadata()

metadata_avis <- metadata_avis %>%
  mutate_if(is.character, ~ na_if(., "NA"))

# Fonction pour compléter les bases de données
appariement_avis_membre <- function(metadata_auteur_intermediate, metadata_avis_intermediate) {
  # Séparer les rapporteurs et les membres_gt et créer une relation entre chaque auteur et le document
  metadata_rapporteurs_long <- metadata_avis_intermediate %>%
    select(num, rapporteurs) %>%
    separate_rows(rapporteurs, sep = ",\\s*") %>%
    rename(nom = rapporteurs) %>%
    mutate(role_avis = 'rapporteur')

  metadata_membres_gt_long <- metadata_avis_intermediate %>%
    select(num, membres_gt) %>%
    separate_rows(membres_gt, sep = ",\\s*") %>%
    rename(nom = membres_gt) %>%
    mutate(role_avis = 'membre_gt')

  # Combiner les deux ensembles de données
  metadata_avis_long <- bind_rows(
    metadata_rapporteurs_long,
    metadata_membres_gt_long
  )

  # Joindre les tables par le nom de l'auteur
  metadata_avis_joined <- metadata_avis_long %>%
    left_join(metadata_auteur, by = "nom")

  # Attribuer à chaque personne la liste des numéros des documents dont il est rapporteur
  auteurs_docs_rapporteurs <- metadata_avis_joined %>%
    filter(role_avis == "rapporteur") %>%
    group_by(id_membre, nom) %>%
    summarise(avis_rapporteur = list(num), .groups = 'drop')

  # Attribuer à chaque personne la liste des numéros des documents dont il est membre_gt
  auteurs_docs_membres_gt <- metadata_avis_joined %>%
    filter(role_avis == "membre_gt") %>%
    group_by(id_membre, nom) %>%
    summarise(avis_membre_gt = list(num), .groups = 'drop')

  # Fusionner les informations des auteurs
  metadata_auteur_intermediate <- metadata_auteur_intermediate %>%
    left_join(auteurs_docs_rapporteurs, by = c("id_membre", "nom")) %>%
    left_join(auteurs_docs_membres_gt, by = c("id_membre", "nom"))

  # Attribuer à chaque document la liste des identifiants des rapporteurs
  docs_ids_rapporteurs <- metadata_avis_joined %>%
    filter(role_avis == "rapporteur") %>%
    group_by(num) %>%
    summarise(ids_rapporteurs = list(id_membre), .groups = 'drop')

  # Attribuer à chaque document la liste des identifiants des membres_gt
  docs_ids_membres_gt <- metadata_avis_joined %>%
    filter(role_avis == "membre_gt") %>%
    group_by(num) %>%
    summarise(ids_membres_gt = list(id_membre), .groups = 'drop')

  # Joindre les résultats pour avoir une vue complète par document
  metadata_avis_intermediate <- metadata_avis_intermediate %>%
    left_join(docs_ids_rapporteurs, by = "num") %>%
    left_join(docs_ids_membres_gt, by = "num")

  return(list(metadata_auteur = metadata_auteur_intermediate, metadata_avis = metadata_avis_intermediate))
}

# Appeler la fonction et obtenir les data.frames complétés
result <- appariement_avis_membre(metadata_auteur, metadata_avis)

# Récupérer les data.frames complétés
metadata_auteur <- result$metadata_auteur
metadata_avis <- result$metadata_avis

rm(result)

metadata_auteur <- metadata_auteur|>
  mutate(nb_avis_as_rapporteur = sapply(avis_rapporteur, length),
         nb_avis_as_membre_gt = sapply(avis_membre_gt, length),
         nb_avis_as_participant = nb_avis_as_rapporteur + nb_avis_as_membre_gt)
```

# Point sur la méthodologie

Par simplicité, j'ai attribué à chaque membre le président en exercice au moment de sa nomination. Cela permet d'avoir un indicateur de temps simple pour comparer, mais cela ne donne pas à chaque instant t, la composition du CCNE. De plus je n'ai que les années de nomination, a moins d'aller sur le JORF pour trouver toutes les dates de nomination, mais celle du JORF sont souvent en retard sur les dates réelles. 

Voici une description des 12 catégories de professions recodées:

- **Politicien ou militant** : Inclut les personnes ayant une profession liée à la politique ou à l'activisme (notamment association de défense de la famille, beaucoup nommé par le Ministère de la famille), y compris ceux qui ont une carrière antérieure dans la médecine.
- **Journaliste/presse** : Regroupe les individus travaillant dans le journalisme ou les médias, dont les patrons de presse.
- **Théologien** : Comprend les personnes spécialisées dans la théologie, toutes religions comprises.
- **Médecin PUPH** : Se réfère aux médecins Professeurs des Universités-Praticiens Hospitaliers (PUPH), excluant les généralistes et libéraux.
- **Chercheur bio** : Regroupe les chercheurs en biologie, physiologie ou pharmacologie.
- **Autres professions santé** : Inclut les pharmaciens, infirmiers, psychologues, généralistes, et cadres supérieurs de santé.
- **Profession du droit** : Englobe les avocats, magistrats, juges et juristes, dont les conseillers d'état et membres de la cours de cassation.
- **Cadre public/privé** : Regroupe les hauts fonctionnaires, enarques, cadres et ingénieurs. Un certain nombre de personnes ont été haut fonctionnaire puis cadre de grands groupes industriels notamment dans les personnes nommées par le ministère de l'industrie. Peut être faudrait il séparer les hauts fonctionnaires selon leur type de spécialité.
- **Chercheur droit** : Juriste universitaire.
- **Chercheur SHS (Sciences Humaines et Sociales)** : Inclut les chercheurs en sociologie, anthropologie, histoire, économie, psychologie, démographie, philosophie, géographie, sciences politiques, littérature, muséologie, et des spécialistes universitaires des religions (judaïsme notamment)
- **Chercheur sciences exactes** : Regroupe les chercheurs en mathématiques, chimie, physique et informatique.
- **Inconnue** : Catégorie pour les professions qui ne correspondent à aucune des précédentes ou dont les informations sont insuffisantes pour le recodage.


# Description des membres du CCNE

## Nombre de membres

### Selon la profession

```{r}
#| fig-width: 12
#| fig-height: 5.5
metadata_auteur|>
  group_by(profession_recodée)|>
  summarise(count = n())|>
  ggbarplot(x='profession_recodée',fill = 'profession_recodée', y = 'count',
            label = TRUE,
            ylab = "Nombre de membres", xlab = "Profession",
            title = "Nombre de membre du CCNE\nselon leur profession")+
  theme_ready()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_y_continuous(expand = expansion(mult = c(0, 1)))+
  scale_fill_prism(palette = "floral")+
  labs(fill = "Profession")+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées par l'auteur.\nLecture : Parmi les 282 membres repertoriés du CCNE, la profession majoritaire est médecin (PUPH) avec 87 membres.")

if(save_figures)
  ggsave("../output/descriptive_members/nombre_profession.png", width = 12, height = 8)
```
Sans trop d'étonnement, la profession dominante sont les médecins hospitaliers et universitaires (PUPH), suivi de près par les chercheurs en sciences humaines (en majorité en philosophie), puis les biologistes et les politiciens (dont un certain nombre sont des médecins, mais plutôt libéraux). Pour finir le droit est aussi bien représenté entre les membres du conseil d'état, de la cour de cassation, des juristes (de profession ou universitaires).

### Selon le genre

```{r}
#| fig-width: 12
#| fig-height: 5.5
metadata_auteur|>
  group_by(président_première_nomination,sexe)|>
  summarise(count = n())|>
  ggbarplot(x='président_première_nomination',fill = 'sexe', y = 'count',
            position = position_dodge(),
            label = TRUE,
            ylab = "Nombre de membres", xlab = "Président à la première nomination",
            title = "Nombre de membre du CCNE\nselon leur genre et le président à leur première nomination")+
  theme_ready()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_y_continuous(expand = expansion(mult = c(0, 0.2)))+
  scale_fill_prism(palette = "floral")+
  labs(fill = "Sexe")+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans 40 ans de Bioéthique (Delfraissy 2023) et par l'auteur.\nLecture : Sous Bernard (83-91), il y a avait deux fois plus d'homme que de femmes nommées au CCNE.\nA partir d'Ameisen (12-15), ce ratio s'équilibre.")

if(save_figures)
  ggsave("../output/descriptive_members/nombre_sexe_président.png")
```

## durée mandat

### Selon le genre et le président

```{r}
#| fig-width: 12
#| fig-height: 8
metadata_auteur|>  
  ggboxplot(x='président_première_nomination',fill = 'sexe', y = 'durée_mandat',
            add = 'jitter',add.params = list(fill = 'sexe', shape = 21),
            ylab = "Durée total du mandat", xlab = "Président à la première nomination",
            title = "Durée total des mandats effectués au CCNE\nselon leur genre et le président à leur première nomination")+
  theme_ready()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_fill_prism(palette = "floral")+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans 40 ans de Bioéthique (Delfraissy 2023) et par l'auteur.\nLecture : Sous Bernard (83-91), les mandats pouvait s'étendre de deux ans à plus de 20 ans.\nAu cours du temps la durée s'est normalisée autour de 5 ans, avec des maximums à une 10 ans.\nChaque point représente un membre du CCNE, la barre noire la moyenne.")
if(save_figures)
  ggsave("../output/descriptive_members/durée_mandat_sexe_président.png")
```
On voit que la durée du mandat est a eu tendance à baisser et à se normaliser autour de 5 ans, avec encore quelques personnes qui font plus.

## Âge à la première nomination
### Selon la profession
```{r}
#| fig-width: 12
#| fig-height: 8
metadata_auteur|>  
  ggboxplot(x='profession_recodée',fill = 'profession_recodée', y = 'age_première_nomination',
            #facet.by = 'président_première_nomination',
            add = 'jitter',add.params = list(fill = 'profession_recodée', shape = 21),
            ylab = "âge à la première nomination", xlab = "Profession",
            title = "âge à la première nomination au CCNE\nselon leur profession")+
  theme_ready()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_fill_prism(palette = "floral")+
  labs(fill = "Profession")+
  guides(fill = guide_legend(title.position = "top"))+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans 40 ans de Bioéthique (Delfraissy 2023) et par l'auteur.\nLecture : L'âge moyen à la nomination au CCNE est de 60 ans.\nLes théologiens sont tendanciellement plus jeunes avec une première nomination à 50 ans en moyenne. ")

if(save_figures)
  ggsave("../output/descriptive_members/age_profession.png", width = 12, height = 8)
```

Globalement les membres du CCNE sont assez âgés quand ils sont nommés pour la première fois, à l'exception notable des théologiens (toutes religions comprises). L'âge moyen est de 60 ans sur l'ensemble des membres. Aucune tendance en terme d'évolution de l'âge à la première nomination semble vraiment être identifiable.

## Complétude des données récoltées
```{r}
#| fig-width: 12
#| fig-height: 10
library(dplyr)
library(ggpubr)
library(ggplot2)

metadata_auteur %>%
  mutate(naissance_inconnue = is.na(naissance)) %>%
  group_by(naissance_inconnue, sexe) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(sexe) %>%
  mutate(total = sum(count), percentage = 100 * count / total) %>%
  ungroup() %>%
  select(-total) %>%
  ggbarplot(x = 'sexe', fill = 'naissance_inconnue', y = 'percentage',
            position = position_stack(), 
            ylab = "% des membres", xlab = "Sexe",
            title = "Pourcentage des membres du CCNE\nselon que leur âge soit collecté ou non") +
  theme_ready() +
  scale_fill_prism(palette = "floral") +
  scale_fill_manual(
    values = c("FALSE" = "#7CA0D4", "TRUE" = "#A48AD3"), 
    labels = c("FALSE" = "FAUX", "TRUE" = "VRAI"),
    name = "Naissance inconnue"
  ) +
  guides(fill = guide_legend(title.position = "top")) +
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans 40 ans de Bioéthique (Delfraissy 2023) et par l'auteur.\nLecture : La collecte des dates de naissance des femmes est plus parcellaire,\navec plus de 25% des femmes sans cette information.")


if(save_figures)
  ggsave("../output/descriptive_members/naissance_inconnue_sexe.png", width = 8, height = 10)
```

On voit qu'il y a une différence de genre : il est plus dure de trouver certaines informations pour les femmes.

# Nombre de participation à un avis, et différence selon la participation à l'écriture d'avis

On se limite aux membres du CCNE qui l'ont rejoint après (ou égale) à 2002, car c'est à partir de là qu'on a des informations quasi exhaustive sur les auteurs des avis.

## Histo participation

```{r}
#| fig-width: 12
#| fig-height: 7
metadata_auteur_2002 <- metadata_auteur|>
  filter(début>= 2002 | début2 >= 2002)

histo_participation_membre <- metadata_auteur_2002|>
  gghistogram(x = "nb_avis_as_participant", fill = "sexe",#fill = "#004080",
              position = position_stack(),
              ylab = "Nombre de membres", xlab = "Nombre de participation à un avis")+
  theme_ready()+
  scale_fill_prism(palette = "floral")+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans 40 ans de Bioéthique (Delfraissy 2023) et par l'auteur.\nLecture : Sur les 151 membres nommés à partir de 2002,\n24 ont participé à un groupe de travail,\navec une égale répartition homme femme.")

histo_participation_membre
if(save_figures)
  ggsave("../output/descriptive_members/histo_participation.png")
```
## Histo rapporteurs
```{r}
#| fig-width: 7
#| fig-height: 7
histo_participation_rapporteurs <- metadata_auteur_2002|>
  gghistogram(x = "nb_avis_as_rapporteur", fill = "sexe",#fill = "#004080",
              position = position_stack(),
              ylab = "Nombre de membre", xlab = "Nombre de fois rapporteur d'un avis")+
  theme_ready()+
  scale_fill_prism(palette = "floral")+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans 40 ans de Bioéthique (Delfraissy 2023) et par l'auteur.\nLecture : Sur les 151 membres nommés à partir de 2002,\nPlus de la moitié n'ont pas participé une fois en tant que rapporteur.")
histo_participation_rapporteurs
if(save_figures)
  ggsave("../output/descriptive_members/histo_nb_rapporteur.png")
```
## Histo membre et rapporteurs ensemble
```{r, fig.height=5, fig.width=12}
histo_participation_membre+histo_participation_rapporteurs

```

```{r}
metadata_auteur_2002 <- metadata_auteur_2002|>
  mutate(once_rapporteur = nb_avis_as_rapporteur>0)


```

## Rapporteurs selon profession

```{r}
#| fig-width: 12
#| fig-height: 6
metadata_auteur_2002 %>%
  mutate(nb_avis_as_rapporteur_discretized = case_when(
    nb_avis_as_rapporteur == 0 ~ "0",
    nb_avis_as_rapporteur == 1 ~ "1",
    nb_avis_as_rapporteur == 2 ~ "2",
    nb_avis_as_rapporteur >= 3 ~ "3+",
  ))%>%
  group_by(nb_avis_as_rapporteur_discretized, profession_recodée) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(profession_recodée) %>%
  mutate(total = sum(count), percentage = 100 * count / total) %>%
  ungroup() %>%
  select(-total)%>%
  ggbarplot(x='profession_recodée',fill = 'nb_avis_as_rapporteur_discretized', y = 'percentage',
            position = position_stack(), 
            #label = TRUE,lab.nb.digits = 2,lab.pos = "in",
            ylab = "% des membres", xlab = "Profession",
            title = "Pourcentage des membre du CCNE\nselon leur profession\net selon le nombre d'avis en tant que rapporteur")+
  theme_ready()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_fill_prism(palette = "floral")+
  labs(fill = "Nombre d'avis en tant que rapporteurs")+
  guides(fill = guide_legend(title.position = "top"))+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans 40 ans de Bioéthique (Delfraissy 2023) et par l'auteur.\nLecture : Sur les membres PUPH nommés après 2002, plus de la moitié à participé au moins une fois en tant que rapporteur.")


if(save_figures)
  ggsave("../output/descriptive_members/pourcentage_profession_nb_avis_as_rapporteur.png", width = 8, height = 10)
```


```{r}
#| fig-width: 12
#| fig-height: 6
metadata_auteur_2002 %>%
  mutate(once_rapporteur = ifelse(once_rapporteur,'VRAI','FAUX'))%>%
  group_by(once_rapporteur, profession_recodée) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(once_rapporteur) %>%
  mutate(total = sum(count), percentage = 100 * count / total) %>%
  ungroup() %>%
  select(-total)%>%
  ggbarplot(x='once_rapporteur',fill = 'profession_recodée', y = 'percentage',
            position = position_stack(), 
            #label = TRUE,lab.nb.digits = 2,lab.pos = "in",
            ylab = "% des membres", xlab = "a été au moins\nune fois rapporteur",
            title = "Pourcentage des membres du CCNE (nommés après 2002)\nselon avoir été rapporteur et la profession.")+
  theme_ready()+
  scale_fill_prism(palette = "floral")+
  labs(fill = "Profession")+
  guides(fill = guide_legend(title.position = "top"))+
  rotate()+
  grids(axis = "x")+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans les avis et de l'auteur.\nLecture : 40% des membres qui ont été rapporteurs sont des médecins PUPH,\nce qui est dix points de plus que le pourcentage qu'ils occupent en tant que membres du CCNE.")

if(save_figures)
  ggsave("../output/descriptive_members/pourcentage_once_rapporteur_profession.png", width = 8, height = 10)
```


# Composition des rapporteurs par avis

```{r, fig.width=30, fig.height=12}
# Exploser la colonne avis_rapporteur pour avoir une ligne par personne et par avis
metadata_avis_membre <- metadata_auteur_2002 %>%
  unnest(avis_rapporteur)

# Combiner les trois opérations en une seule
percentage_participation <- metadata_avis_membre %>%
  group_by(avis_rapporteur) %>%
  mutate(total_count = n()) %>%
  group_by(avis_rapporteur, profession_recodée, id_membre) %>%
  summarise(
    profession_count = n(),
    total_count = first(total_count)
  ) %>%
  mutate(percentage = 100 * profession_count / total_count) %>%
  select(avis_rapporteur, profession_recodée,id_membre, percentage) %>%
  rename(num = avis_rapporteur)

# Graphique en barres empilées
plot_participation_par_avis <- ggplot(percentage_participation, aes(x = factor(num), y = percentage, fill = profession_recodée)) +
  geom_bar(stat = "identity", position = "stack", alpha = 1, color = "black", size =2) +
  theme_ready(text_size = 37) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_prism(palette = "floral") +
  labs(fill = "Profession", color = "Profession",
       title = "Proportion des professions au fil du temps par avis", x = "Numéro avis et date de publication", y = "Pourcentage") +
  guides(fill = guide_legend(title.position = "top")) +
  labs(caption = "Graphique de l'auteur.\nDonnées collectées par l'auteur.\nLecture : L'avis 92 a été écrit par deux PUPH et un politicien ou militant.")
plot_participation_par_avis
```
# Multinominés

```{r}
#| fig-width: 12
#| fig-height: 6
metadata_auteur %>%
  mutate(multinominated = ifelse(str_count(nomination,';')>0,'VRAI','FAUX'))%>%
  group_by(multinominated, profession_recodée) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(multinominated) %>%
  mutate(total = sum(count), percentage = 100 * count / total) %>%
  ungroup() %>%
  select(-total)%>%
  ggbarplot(x='multinominated',fill = 'profession_recodée', y = 'percentage',
            position = position_stack(), 
            #label = TRUE,lab.nb.digits = 2,lab.pos = "in",
            ylab = "% des membres", xlab = "a être multinominé",
            title = "Pourcentage des membres du CCNE multinominé par profession.")+
  theme_ready()+
  scale_fill_prism(palette = "floral")+
  labs(fill = "Profession")+
  guides(fill = guide_legend(title.position = "top"))+
  rotate()+
  grids(axis = "x")+
  labs(caption = "Graphique de l'auteur.\nDonnées collectées dans les avis et de l'auteur.\nLecture : 38% des multinominés sont des médecins PUPH et seulement 30% des non multinominés.")
```

# Liens avec les institutions dirigeantes (QGS)

```{r}
#| output: false
QGS <- read_csv("../data/intermediate/qui gouverne la science/sele_Matrice.csv")%>%
  select(-...1)%>%
  rename(sexe.qgs = sexe.x,
         sexe.leo = sexe.y,
         nom.leo = nom.y,
         nom.qgs = nom,
         summary = '0')

# Apply the function to remove columns with only zeros from column 6 to column 424
# Function to remove columns with only zeros in a specified range and move the last 6 columns to the beginning
remove_zero_and_reorder <- function(df, start_col, end_col, num_last_cols) {
  # Identify the last 'num_last_cols' columns
  last_cols <- tail(names(df), num_last_cols)
  
  # Subset the data frame to the specified range
  sub_df <- df[, start_col:end_col]
  
  # Identify columns that are not full of zeros
  non_zero_cols <- colSums(sub_df != 0) > 0
  
  # Columns to keep (including non-zero columns)
  cols_to_keep <- c(last_cols, names(df)[1:(start_col - 1)], names(df)[start_col:end_col][non_zero_cols])
  
  # Reorder the columns
  result_df <- df[, cols_to_keep]
  
  return(result_df)
}

# Define the range and number of last columns to move
QGS <- remove_zero_and_reorder(QGS, 6, 417, 6)

QGS$nb_affiliations <- rowSums(QGS[, 11:90])

# Get the current column names
col_names <- colnames(QGS)

# Define the new order of columns
new_order <- c(col_names[1:9], "nb_affiliations", col_names[10:(ncol(QGS) - 1)])

# Reorder the data frame
QGS <- QGS[, new_order]

# je m'étais trompé dans le genre de 
# Valérie Masson-Delmotte (F et non H)
# et de Dominique Thouvenin (H et non F)
# je corrige dans le fichier sele_Matrice et dans metadata_auteur 
# mais pas dans les fichiers envoyés à Joël pour garder l'historique
# First test is sexe.leo == sexe.qgs
print(any(QGS$sexe.leo!=QGS$sexe.qgs))
# Maintenant let's look at the actual affiliations

# QGS%>%
#   select(id_membre, nom.leo, profession, spécialité, naissance, sexe.leo, nb_affiliations,summary)%>%
#   View()


# Problème je crois : deux Louis Schweitzer, l'un haut fonctionnaire et ancien PDG de renault, l'autre pasteur.

id_membres_faux_appareillement = c(17)
QGS%>%
  filter(!(id_membre %in% id_membres_faux_appareillement)) -> QGS
```

```{r}
# base ultra détaillée
# faut il que je reclassifie certains membres du ccne puph en biologiste
detailled_qgs_few_members <- read_csv("../data/intermediate/qui gouverne la science/sele_Base.csv")

```

```{r}
membres_ccne_qgs <- left_join(metadata_auteur_2002,QGS%>%
                                 select(id_membre,nb_affiliations), by = "id_membre")%>%
  mutate(nb_affiliations = ifelse(is.na(nb_affiliations),0,nb_affiliations))
```

```{r,  fig.width=11, fig.height=7}
membres_ccne_qgs |>
  mutate(label_debut = ifelse(((nb_avis_as_rapporteur>=0)&(nb_affiliations>0)),début,""))%>%
  ggscatter(x = "nb_avis_as_participant", y = "nb_affiliations", shape = "sexe", color = "président_première_nomination",
            xlab = "Nombre d'avis en tant que participant", ylab = "Nombre d'affiliations (QGS)", 
            label = "label_debut", repel = T,
            position = position_jitter(width = 0.2, height = 0.2)) +
  geom_text(
    data = subset(membres_ccne_qgs, sapply(nomination, is_president_CCNE)),
    aes(label = nom),
    vjust = -1, hjust = 0.5, size = 3, color = "red"
  ) +
  theme_ready() +
  theme_ready(text_size = 16) +
  scale_color_prism(palette = "winter_bright") +
  guides(color = guide_legend(title.position = "top"),
         shape = guide_legend(title.position = "top")) +
  labs(title = "Investissement en tant que rapporteurs,\ncomparés à l'investissement dans la direction de la science\n(membres nommés après 2002)",
       color = "Président à la première nomination",
       caption = "Graphique de l'auteur.\nDonnées collectées par l'auteur; et issues de la base Qui Gouverne la Science (Laillier et Topalov 2022).\nLecture : L'investissement dans des institutions de gouvernance de la science semble aller à l'opposé de l'investissement au CCNE.") +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red")+
  ggpubr::grids(axis = "xy")

if(save_figures)
  ggsave("../output/descriptive_members/participation_vs_qgs.png")
```
```{r, fig.width=11, fig.height=7}
palette_colors <- c("1" = "#008080", "2" = "#55A0FB", "3" = "#285291", "4" = "#000080", 
                    "5" = "#91188E", "6+" = "#AD07E3", "10+" = "#FF8080", "20+" = "#800040", "50+" = "#21063F")

membres_ccne_qgs %>%
  group_by(nb_avis_as_participant, nb_affiliations) %>%
  summarise(`Nombre de membres` = n()) %>%
  mutate(code_couleur = cut(`Nombre de membres`,
                                   breaks = c(1, 2, 3, 4, 5, 6, 10, 20, 50, Inf),
                                   labels = c("1", "2", "3", "4", "5", "6+", "10+", "20+", "50+"),
                                   right = FALSE)) %>%
ggplot(aes(x = nb_avis_as_participant, y = nb_affiliations, label = `Nombre de membres`, color = code_couleur)) +
  geom_text(size = 6) +
  scale_color_manual(values = palette_colors) +
  theme_ready(text_size = 20) +
  guides(color = guide_legend(title.position = "top")) +
  labs(title = "Investissement dans un groupe de travail du CCNE,\ncomparés à l'investissement dans la direction de la science\n(membres nommés après 2002)",
       color = "Nombre de membres avec ce nombre d'affiliation et d'avis en tant que rapporteurs",
       caption = "Graphique de l'auteur.\nDonnées collectées par l'auteur et issues de la base Qui Gouverne la Science (Laillier et Topalov 2022).\nInterprétation : L'investissement dans des institutions de gouvernance de la science\nsemble aller à l'opposé de l'investissement au CCNE.\nLecture : Chaque chiffre est le nombre de membres qui partagent le même nombre\nd'institutions d'appartenance dans la base QGS et de participation à des groupes de travail.",
       x = "Nombre d'avis en tant que membre d'un groupe de travail", y = "Nombre d'affiliations (QGS)") +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red") +
  ggpubr::grids(axis = "xy")+
  geom_text(data = subset(membres_ccne_qgs, sapply(nomination, is_president_CCNE)), 
            aes(x = nb_avis_as_rapporteur, y = nb_affiliations, label = nom), 
            vjust = 0.5, hjust = -0.1, size = 3, color = "red")

```

```{r, fig.width=11, fig.height=7}
# Exemple de palette de couleurs personnalisée
membres_ccne_qgs |>
  mutate(label_debut = ifelse(((nb_avis_as_rapporteur>=0)&(nb_affiliations>0)),début,""))%>%
  ggscatter(x = "nb_avis_as_rapporteur", y = "nb_affiliations", shape = "sexe", color = "président_première_nomination",
            size = 4, label = "label_debut", repel = T,
            position = position_jitter(width = 0.2, height = 0.2),
            xlab = "Nombre d'avis en tant que rapporteur", ylab = "Nombre d'affiliations (QGS)") +
  geom_text(
    data = subset(membres_ccne_qgs, sapply(nomination, is_president_CCNE)),
    aes(label = nom),
    vjust = -1, hjust = 0.5, size = 3, color = "red",
    position = position_jitter(width = 0.2, height = 0.2)
  ) +
  theme_ready(text_size = 16) +
  scale_color_prism(palette = "winter_bright") +
  guides(color = guide_legend(title.position = "top"),
         shape = guide_legend(title.position = "top")) +
  labs(title = "Investissement en tant que rapporteurs,\ncomparés à l'investissement dans la direction de la science\n(membres nommés après 2002)",
       color = "Président à la première nomination",
       caption = "Graphique de l'auteur.\nDonnées collectées par l'auteur; et issues de la base Qui Gouverne la Science (Laillier et Topalov 2022).\nLecture : L'investissement dans des institutions de gouvernance de la science semble aller à l'opposé de l'investissement au CCNE.") +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red") +
  ggpubr::grids(axis = "xy")


```

```{r}
palette_colors <- c("1" = "#008080", "2" = "#55A0FB", "3" = "#285291", "4" = "#000080", 
                    "5" = "#91188E", "6+" = "#AD07E3", "10+" = "#FF8080", "20+" = "#800040", "50+" = "#21063F")

membres_ccne_qgs %>%
  group_by(nb_avis_as_rapporteur, nb_affiliations) %>%
  summarise(`Nombre de membres` = n()) %>%
  mutate(code_couleur = cut(`Nombre de membres`,
                                   breaks = c(1, 2, 3, 4, 5, 6, 10, 20, 50, Inf),
                                   labels = c("1", "2", "3", "4", "5", "6+", "10+", "20+", "50+"),
                                   right = FALSE)) %>%
ggplot(aes(x = nb_avis_as_rapporteur, y = nb_affiliations, label = `Nombre de membres`, color = code_couleur)) +
  geom_text(size = 6) +
  scale_color_manual(values = palette_colors) +
  theme_ready(text_size = 20) +
  guides(color = guide_legend(title.position = "top")) +
  labs(title = "Investissement en tant que rapporteurs,\ncomparés à l'investissement dans la direction de la science\n(membres nommés après 2002)",
       color = "Nombre de membres avec ce nombre d'affiliation et d'avis en tant que rapporteurs",
       caption = "Graphique de l'auteur.\nDonnées collectées par l'auteur et issues de la base Qui Gouverne la Science (Laillier et Topalov 2022).\nInterprétation : L'investissement dans des institutions de gouvernance de la science\nsemble aller à l'opposé de l'investissement au CCNE.\nLecture : Chaque chiffre est le nombre de membres qui partagent le même nombre\nd'institutions d'appartenance dans la base QGS et d'avis rapportés.",
       x = "Nombre d'avis en tant que rapporteur", y = "Nombre d'affiliations (QGS)") +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 10), labels = scales::label_number(accuracy = 1, big.mark = "")) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red") +
  ggpubr::grids(axis = "xy")+
  geom_text(data = subset(membres_ccne_qgs, sapply(nomination, is_president_CCNE)), 
            aes(x = nb_avis_as_rapporteur, y = nb_affiliations, label = nom), 
            vjust = 0.5, hjust = -0.1, size = 3, color = "red")
```

