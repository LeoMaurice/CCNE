---
title: "CCNE Personne across avis"
author: "Léopold MAURICE"
date: "2024-06-05"
project: CCNE
supervision: Pr. Emmanuel Didier, CMH/ENS/EHESS
format:
  html:
    toc: true
    number-sections: true
    colorlinks: true
    geometry:
      - top=10mm
      - left=20mm
      - right=20mm
      - bottom=10mm  
      - heightrounded
    highlight-style: github
    fontfamily: libertinus
    documentclass: report
    fig-width: 12
    fig-height: 9
  pdf:
    documentclass: article
    geometry: [left=1in, right=1in, top=1in, bottom=1in]
    fontsize: 11pt
    keep-tex: true
    toc: true
    toc-depth: 2
    number-sections: true
execute:
  eval: true
  message: false
  warning: false
  echo: false
  output: true
  error: true
editor: source
---

```{r}
require(pacman,quietly = F)

pacman::p_load(arrow,
               tidyverse,
               reshape2,
               stringr,
               
               igraph,
               #sna,
               #network,

               stats,
               rstatix,
               
               ggplot2,
               gridExtra,
               ggprism,
               ggpubr,
               ggcorrplot,
               #ggraph,
               ggnetwork,
               
               rmarkdown,
               
               readxl)

source("helpers/database_creation.R")
source("helpers/figures.R")

save_figures = T
cutpoints = c(0, 1e-04, 0.001, 0.01, 0.05, 0.1, 1)
symbols = c("****", "***", "**", "*", "•","ns")
significance = c("p < 0.0001", "p < 0.001", "p < 0.01", "p < 0.05", "p < 0.1", "p>0.1")
signif_caption_text <- paste("Significance levels:\n", paste(symbols, ":", significance, collapse = ", "))

```


```{r}
designation_recoding <- Vectorize(function(type, Auteur_Institution, Institution_Domaine) {
  if (type == "classic") {
    return(Auteur_Institution)
  } else if (type == "collectif") {
    return("Collectif")
  } else if (type == "presse spécialisée") {
    return("Presse Spécialisée")
  } else if (type == "presse") {
    return("Presse")
  } else if (type == "loi") {
    return("Loi")
  } else {
    return(Institution_Domaine)
  }
})


metadata_avis <- open_metadata()%>%
  filter(rapporteurs != "NA")

metadata_citation <- read_excel("../data/raw/collected_metadata/metadata_citation.xlsx", 
    col_types = c("text", "text", "text", 
        "text", "text", "text", "numeric", 
        "skip"))%>%
  separate_rows(cité_dans_avis_num, sep = ";")%>%
  separate_rows(Institution_Domaine, sep = ";")%>%
  mutate(type = ifelse(type %in% c("livre","article","colloque"),"académique",type),
         Désignation = designation_recoding(type,Auteur_Institution, Institution_Domaine)
         )

```
```{r, width = 20, heigh = 20}
# Count the number of citations for each Désignation
citation_counts <- metadata_citation %>%
  group_by(Désignation) %>%
  summarise(citation_count = n(), .groups = 'drop')

# Create edge list for the network graph
edge_list_macro <- metadata_citation %>%
  mutate(source = "CCNE") %>%
  select(source, target = Désignation) %>%
  group_by(source, target) %>%
  summarise(weight = n(), .groups = 'drop')

# Create the network graph using igraph
macro_citations_network <- graph_from_data_frame(edge_list_macro, directed = TRUE)

# Add node attributes
V(macro_citations_network)$citation_count <- citation_counts$citation_count[match(V(macro_citations_network)$name, citation_counts$Désignation)]
V(macro_citations_network)$type <- ifelse(V(macro_citations_network)$name == "CCNE", "Source", "Target")

# Convert igraph object to ggnetwork-compatible format
network_data <- ggnetwork(macro_citations_network)

# Plot the network using ggnetwork and ggplot2
ggplot(network_data, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges(aes(), color = "grey50") +
  geom_nodes(aes(size = citation_count)) +
  geom_nodelabel_repel(aes(label = name), box.padding = unit(0.35, "lines")) +
  theme_blank() +
  scale_size_continuous(range = c(3, 10)) +
  ggtitle("Citation Network from CCNE to Institution/Auteur/Genre")
```

