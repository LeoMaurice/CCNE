---
title: "descriptive_figures"
format: html
editor: visual
---
```{r}
pacman::p_load(arrow,
               ggplot2,
               tidyverse,
               gridExtra,
               ggprism,
               ggpubr,
               ggcorrplot,
               ComplexHeatmap,
               circlize,
               reshape2)
source("./helpers/df_to_matrix.R")
```

```{r}
df <- arrow::read_feather('../data/intermediate/big/base_sentences.feather')
```

```{r}
#ggprism::preview_theme("colorblind_safe")
ggprism::prism_color_pal("floral")(6)
```

```{r}
# Assuming you have a data frame called 'df' with columns: num, human, person, societe, nature, position_in_avis
quantile = 50

# Calculate the quantiles for position_in_avis
df_heatmap <- df |> 
  mutate(position_in_avis =sentence_index/number_sentences)|>
  arrange(num, position_in_avis) |>
  group_by(num) |>
  mutate(quantile_group = ntile(position_in_avis, quantile))|>
  ungroup()|>
  group_by(num,quantile_group,president,theme,number_sentences)|>
  summarise(human_nb = sum(human),
            person_nb = sum(person),
            individu_nb = sum(individu),
            societe_nb = sum(societe),
            nature_nb = sum(nature),
            env_nb = sum(environment),
            n_in_quantile = n())|>
  mutate(human_freq = human_nb/n_in_quantile,
         person_freq = person_nb/n_in_quantile,
         individu_freq = individu_nb/n_in_quantile,
         societe_freq = societe_nb/n_in_quantile,
         nature_freq = nature_nb/n_in_quantile,
         env_freq = env_nb/n_in_quantile)
```
Description :
Pour chaque quantile, la couleur sur la carte de chaleur représente la fréquence relative d'un mot spécifique. Pour calculer cette fréquence, nous divisons le nombre d'occurrences du mot par le nombre total de phrases dans le quantile. Cette transformation fournit une mesure de la fréquence à laquelle le mot apparaît au sein du sous-ensemble de phrases représenté par chaque quantile, permettant ainsi de comparer l'utilisation du mot dans différentes parties du texte.
```{r}
ylab = "Position relative de la phrase"
xlab = "Numéro de l'avis"
title = "Carte de chaleur de la distribution de"

plot_width = 20
plot_height = 15
# Préparation des données pour la heatmap
human_matrix <-
  df_to_matrix(df_heatmap,
               Xname = "num",
               Yname = "quantile_group",
               Zname = "human_freq")
person_matrix <-
  df_to_matrix(df_heatmap,
               Xname = "num",
               Yname = "quantile_group",
               Zname = "person_freq")

indiv_matrix <-
  df_to_matrix(df_heatmap,
               Xname = "num",
               Yname = "quantile_group",
               Zname = "individu_freq")

societe_matrix <-
  df_to_matrix(df_heatmap,
               Xname = "num",
               Yname = "quantile_group",
               Zname = "societe_freq")
nature_matrix <-
  df_to_matrix(df_heatmap,
               Xname = "num",
               Yname = "quantile_group",
               Zname = "nature_freq")

env_matrix <-
  df_to_matrix(df_heatmap,
               Xname = "num",
               Yname = "quantile_group",
               Zname = "env_freq")

# Préparation des annotations
colors_palette <-
  ggprism::scale_colour_prism(palette = "colors")$palette
pearl_palette <-
  ggprism::scale_colour_prism(palette = "office")$palette
theme_colors <-
  setNames(colors_palette(length(unique(df_heatmap$theme))), unique(df_heatmap$theme))
president_colors <-
  setNames(pearl_palette(length(unique(
    df_heatmap$president
  ))), unique(df_heatmap$president))

president_annotation <- HeatmapAnnotation(
  df = df_heatmap |>
    group_by(num, president, theme) |>
    summarise() |>
    ungroup() |>
    arrange(num) |>
    select(-num),
  "nombre phrase" = anno_barplot(
    df_heatmap |>
      group_by(num, number_sentences) |>
      summarise() |>
      ungroup() |>
      arrange(num) |>
      select(-num) |>
      as.vector(),
    add_numbers = TRUE,
    height = unit(3,"cm"),
    gp = gpar(fill ="#285291"),
    numbers_rot = 90
  ),
  which = "column",
  show_legend = TRUE,
  annotation_name_side = "right",
  col = list(president = president_colors,
             theme = theme_colors)
)


# Création de la heatmap
heatmap_person <- Heatmap(
  person_matrix,
  name = "personne",
  row_title = "Fréquence présence 'personne'",
  # row_title = "Fréquence par quantile des phrases avec 'personne'",
  column_title = xlab,
  # column_title_side = "bottom",
  col = colorRamp2(c(0, 1), c("white", "#40007F")),
  column_names_gp = gpar(fontsize = 8),
  cluster_rows = FALSE,
  cluster_columns = FALSE,
)

heatmap_humain <- Heatmap(
  human_matrix,
  name = "humain",
  row_title = "Fréquence présence 'humain'",
  col = colorRamp2(c(0, 1), c("white", "#66CCFE")),
  column_names_gp = gpar(fontsize = 8),
  cluster_rows = FALSE,
  cluster_columns = FALSE
)

heatmap_individu<- Heatmap(
  indiv_matrix,
  name = "individu",
  row_title = "Fréquence présence 'individu'",
  col = colorRamp2(c(0, 1), c("white", "#91188E")),
  column_names_gp = gpar(fontsize = 8),
  cluster_rows = FALSE,
  cluster_columns = FALSE
)

heatmap_societe <- Heatmap(
  societe_matrix,
  name = "societe",
  row_title = "Fréquence présence 'société'",
  col = colorRamp2(c(0, 1), c("white", "#FF0066")),
  column_names_gp = gpar(fontsize = 8),
  cluster_rows = FALSE,
  cluster_columns = FALSE
)

heatmap_nature <- Heatmap(
  nature_matrix,
  name = "nature",
  row_title = "Fréquence présence 'nature'",
  # column_title = xlab,
  # column_title_side = "bottom",
  col = colorRamp2(c(0, 1), c("white", "#107F80")),
  column_names_gp = gpar(fontsize = 8),
  cluster_rows = FALSE,
  cluster_columns = FALSE
)

heatmap_env <- Heatmap(
  env_matrix,
  name = "environnement",
  row_title = "Fréquence présence 'environnement'",
  # column_title = xlab,
  # column_title_side = "bottom",
  col = colorRamp2(c(0, 1), c("white", "#539027")),
  column_names_gp = gpar(fontsize = 8),
  cluster_rows = FALSE,
  cluster_columns = FALSE
)



heatmap_list = president_annotation %v% heatmap_person %v% heatmap_humain %v% heatmap_individu %v% heatmap_societe %v% heatmap_nature %v% heatmap_env

pdf("../output/descriptive_figures/more_words_complexheatmaps.pdf", width = plot_width, height = plot_height)  # Adjust size as needed
draw(heatmap_list, column_title = "Cartes de chaleur de la fréquence de la présence de mots dans les phrases par groupe de phrase (2% quantile)",row_title = ylab)
dev.off()

# pdf("../output/descriptive_figures/words_complexheatmaps_person.pdf", width = 18, height = 12)  # Adjust size as needed
# draw(president_annotation %v% heatmap_person, column_title = "Cartes de chaleur de la fréquence de la présence du mot 'personne' dans les phrases par groupe de phrase (2% quantile)",row_title = ylab)
# dev.off()

```

```{r}
# Calculate the correlation matrix
cor_matrix <- cor(df|>ungroup()|>
                    select(human,person,nature,societe))

# Create a correlation matrix plot with ggpubr
corr_plot <- ggcorrplot(cor_matrix, 
                        ggtheme = theme_prism(),
                        colors = c("#FF0066", "white", "#66CCFE"),
                        p.mat = cor_pmat(cor_matrix),
                        lab = TRUE
                        )
corr_plot

ggsave("../output/descriptive_figures/words_corrplot.pdf", 
       plot = corr_plot)
```
```{r}
# Calculate the correlation matrix
cor_matrix <- cor(df_heatmap|>ungroup()|>
                    select(human_freq,person_freq,nature_freq,societe_freq))

# Create a correlation matrix plot with ggpubr
corr_plot <- ggcorrplot(cor_matrix, 
                        ggtheme = theme_prism(),
                        colors = c("#FF0066", "white", "#66CCFE"),
                        p.mat = cor_pmat(cor_matrix),
                        lab = TRUE
                        )
corr_plot

ggsave("../output/descriptive_figures/words_quantile_corrplot.pdf", 
       plot = corr_plot)
```
    