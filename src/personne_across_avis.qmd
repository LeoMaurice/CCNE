---
title: "CCNE Personne across avis"
author: "Léopold MAURICE"
date: "2024-06-05"
project: CCNE
supervision: Pr. Emmanuel Didier, CMH/ENS/EHESS
format:
  html:
    toc: true
    number-sections: true
    colorlinks: true
    geometry:
      - top=10mm
      - left=20mm
      - right=20mm
      - bottom=10mm  
      - heightrounded
    highlight-style: github
    fontfamily: libertinus
    documentclass: report
    fig-width: 12
    fig-height: 9
  pdf:
    documentclass: article
    geometry: [left=1in, right=1in, top=1in, bottom=1in]
    fontsize: 11pt
    keep-tex: true
    toc: true
    toc-depth: 2
    number-sections: true
execute:
  eval: true
  message: false
  warning: false
  echo: false
  output: true
  error: true
editor: source
---

```{r}
require(pacman,quietly = F)

pacman::p_load(arrow,
               tidyverse,
               reshape2,
               stringr,

               stats,
               rstatix,
               
               ggplot2,
               gridExtra,
               ggprism,
               ggpubr,
               ggcorrplot,
               ComplexHeatmap,
               circlize,
               patchwork,
               rmarkdown,
               readxl,
               readr)

source("helpers/database_creation.R")
source("helpers/figures.R")

save_figures = T
cutpoints = c(0, 1e-04, 0.001, 0.01, 0.05, 0.1, 1)
symbols = c("****", "***", "**", "*", "•","ns")
significance = c("p < 0.0001", "p < 0.001", "p < 0.01", "p < 0.05", "p < 0.1", "p>0.1")
signif_caption_text <- paste("Significance levels:\n", paste(symbols, ":", significance, collapse = ", "))

```

```{r}
predictions_BERT <- read_csv("../data/intermediate/predictions/predictions_camemBERT_1400annotations_5classes_2024-06-04.csv", 
    col_types = cols(sentence_id = col_integer(), 
        pred_label = col_integer())) %>%
  mutate(
    sentence_index = as.numeric(substr(sentence_id, nchar(as.character(sentence_id)) - 3, nchar(as.character(sentence_id)))),
    num = as.numeric(substr(sentence_id, 1, nchar(as.character(sentence_id)) - 4))
  )

recat <- c("Corps humain" = "Corps humain",
           "Genre/espèce humaine" = "Genre/espèce humaine",
           "Individu ou sujet" = "Individu ou sujet",
           "Personne à protéger" = "Personne droits et devoirs",
           "Personne responsable et autonome" = "Personne droits et devoirs",
           "Personne relationnelle" = "Personne relationnelle",
           "Sentiment humain" = "Genre/espèce humaine",
           "Poubelle" = "Poubelle")

annotations <- read_csv("../data/intermediate/annotations/personne_withSentence_1400annotations_2024-06-03_ActiveTigger.csv")%>%
  rename(annotation_label = Personne)%>%
  mutate(training_label = recode(annotation_label, !!!recat))%>%
  select(sentence_id,training_label,annotation_label)

# base avec métadonnées au niveau des avis, sans découper au niveau des phrases
base_avis <- arrow::read_feather('../data/intermediate/big/base_avis.feather')
levels_order <- c( "Bernard (83-91)", "Changeux (92-99)","Sicard (00-08)", "Grimfeld (09-11)", "Ameisen (12-15)", "Delfraissy (16-)")

base_avis$president <- factor(base_avis$president, levels = levels_order)

predictions <- predictions_BERT %>%
  left_join(annotations, by = "sentence_id")%>%
  mutate(label = ifelse(!is.na(training_label), training_label, pred_Personne))%>%
  filter(label != "Poubelle")%>%
  left_join(base_avis, by = "num")%>%
  mutate(label = factor(label, levels = c("Personne relationnelle","Individu ou sujet","Genre/espèce humaine",
                                         "Corps humain","Personne droits et devoirs")),
         Date = as.Date(Date))
```

```{r}
#| fig-width: 12
#| fig-height: 10
predictions %>%
  group_by(president, label) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(president) %>%
  mutate(total = sum(count), percentage = 100 * count / total) %>%
  ungroup() %>%
  select(-total)%>%
  ggbarplot(x='president',fill = 'label', y = 'percentage',
            position = position_stack(), 
            #label = TRUE,lab.nb.digits = 2,lab.pos = "in",
            ylab = "% des phrases", xlab = "Président",
            title = "Pourcentage des phrases\nselon leur labelisationn\net selon le président au moment de la publication de l'avis")+
  theme_ready()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_fill_prism(palette = "floral")+
  labs(fill = "Label")+
  guides(fill = guide_legend(title.position = "top"))
```

```{r, fig.width=20, fig.height=15}
#| fig-width: 12
#| fig-height: 10

# Convert Date to quarter
predictions <- predictions %>%
  mutate(quarter = paste0(year(Date), "-Q", quarter(Date)))

# Get all unique labels
all_labels <- unique(predictions$label)

# Get all unique quarters
all_quarters <- predictions %>%
  mutate(quarter = paste0(year(Date), "-Q", quarter(Date))) %>%
  arrange(Date) %>%
  distinct(quarter) %>%
  pull(quarter)
# Create a numeric sequence for quarters
quarter_numeric <- 1:length(all_quarters)

# Map quarters to numeric sequence
quarter_map <- data.frame(quarter = all_quarters, quarter_num = quarter_numeric)

# Complete missing values with 0 and compute percentages
temp <- predictions %>%
  mutate(quarter = factor(quarter, levels = all_quarters)) %>%
  group_by(quarter, label) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(quarter) %>%
  mutate(percentage = 100 * count / sum(count)) %>%
  ungroup() %>%
  complete(quarter = all_quarters, label = all_labels, fill = list(percentage = 0)) %>%
  left_join(quarter_map, by = "quarter")

# Graphique en aires empilées
ggplot(temp, aes(x = quarter_num, y = percentage, fill = label)) +
  geom_area(position = "stack", alpha = 0.8) +
  theme_ready() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_prism(palette = "floral") +
  scale_color_prism(palette = "floral") +
  scale_x_continuous(breaks = quarter_numeric, labels = all_quarters) +
  labs(fill = "Label", color = "Label",
       title = "Proportion des catégories au fil du temps", x = "Trimestre", y = "Pourcentage") +
  guides(fill = guide_legend(title.position = "top"))


```


```{r, fig.width=20, fig.height=15}
# Convert Date to semester
predictions <- predictions %>%
  mutate(semester = paste0(year(Date), "-S", ifelse(month(Date) <= 6, 1, 2)))

# Get all unique labels
all_labels <- unique(predictions$label)

# Get all unique semesters and order them chronologically
all_semesters <- predictions %>%
  arrange(Date) %>%
  distinct(semester) %>%
  pull(semester)

# Create a numeric sequence for semesters
semester_numeric <- seq_along(all_semesters)

# Map semesters to numeric sequence
semester_map <- data.frame(semester = all_semesters, semester_num = semester_numeric)

# Complete missing values with 0 and compute percentages
temp <- predictions %>%
  mutate(semester = factor(semester, levels = all_semesters)) %>%
  group_by(semester, label) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(semester) %>%
  mutate(percentage = 100 * count / sum(count)) %>%
  ungroup() %>%
  complete(semester = all_semesters, label = all_labels, fill = list(percentage = 0)) %>%
  left_join(semester_map, by = "semester")

# Graphique en aires empilées
ggplot(temp, aes(x = semester_num, y = percentage, fill = label)) +
  geom_area(position = "stack", alpha = 0.8) +
  geom_line(position = "stack", color = "black", linetype = "dashed", size =1)+
  theme_ready() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_prism(palette = "floral") +
  scale_x_continuous(breaks = semester_numeric, labels = all_semesters) +
  labs(fill = "Label", color = "Label",
       title = "Proportion des catégories au fil du temps", x = "Semestre", y = "Pourcentage") +
  guides(fill = guide_legend(title.position = "top"))
```
```{r, fig.width=20, fig.height=10}
# Convert Date to year
predictions <- predictions %>%
  mutate(year = year(Date))

# Get all unique labels
all_labels <- unique(predictions$label)

# Get all unique years and order them chronologically
all_years <- sort(unique(predictions$year))

# Complete missing values with 0 and compute percentages
temp <- predictions %>%
  group_by(year, label) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(year) %>%
  mutate(percentage = 100 * count / sum(count)) %>%
  ungroup() %>%
  complete(year = all_years, label = all_labels, fill = list(percentage = 0))

# Graphique en aires empilées
ggplot(temp, aes(x = year, y = percentage, fill = label)) +
  geom_area(position = "stack", alpha = 0.8) +
  geom_line(position = "stack", color = "black", linetype = "dashed", size =1)+
  theme_ready() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_prism(palette = "floral") +
  scale_x_continuous(breaks = all_years) +
  labs(fill = "Label", color = "Label",
       title = "Proportion des catégories au fil du temps", x = "Année", y = "Pourcentage") +
  guides(fill = guide_legend(title.position = "top"))
```
```{r, fig.width=20, fig.height=15}
# Convert Date to two-year steps
predictions <- predictions %>%
  mutate(two_year = year(Date) %/% 2 * 2)

# Get all unique labels
all_labels <- unique(predictions$label)

# Get all unique two-year steps and order them chronologically
all_two_years <- sort(unique(predictions$two_year))

# Complete missing values with 0 and compute percentages
temp <- predictions %>%
  group_by(two_year, label) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(two_year) %>%
  mutate(percentage = 100 * count / sum(count)) %>%
  ungroup() %>%
  complete(two_year = all_two_years, label = all_labels, fill = list(percentage = 0))


# Graphique en aires empilées
ggplot(temp, aes(x = two_year, y = percentage, fill = label)) +
  geom_area(position = "stack", alpha = 0.8) +
  theme_ready() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_prism(palette = "floral") +
  scale_color_prism(palette = "floral") +
  scale_x_continuous(breaks = seq_along(all_two_years), labels = all_two_years) +
  labs(fill = "Label", color = "Label",
       title = "Proportion des catégories au fil du temps", x = "Deux ans", y = "Pourcentage") +
  guides(fill = guide_legend(title.position = "top"))
```

